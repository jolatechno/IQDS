\hypertarget{load__balancing_8hpp_source}{}\doxysection{load\+\_\+balancing.\+hpp}
\label{load__balancing_8hpp_source}\index{src/utils/load\_balancing.hpp@{src/utils/load\_balancing.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{2 }
\DoxyCodeLine{3 \textcolor{preprocessor}{\#include <iterator>}}
\DoxyCodeLine{4 }
\DoxyCodeLine{6 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacequids_1_1utils}{quids::utils}} \{}
\DoxyCodeLine{7 }
\DoxyCodeLine{9     \textcolor{keyword}{template} <\textcolor{keyword}{class} Un\textcolor{keywordtype}{signed}IntIterator1, \textcolor{keyword}{class} Un\textcolor{keywordtype}{signed}IntIterator2>}
\DoxyCodeLine{10     \textcolor{keywordtype}{void} \textcolor{keyword}{inline} \mbox{\hyperlink{namespacequids_1_1utils_a26acad53fb0779fa4d590533dbf48d7b}{load\_balancing\_from\_prefix\_sum}}(UnsignedIntIterator1 prefixSumLoadBegin, UnsignedIntIterator1 prefixSumLoadEnd,}
\DoxyCodeLine{11         UnsignedIntIterator2 workSharingIndexesBegin, UnsignedIntIterator2 workSharingIndexesEnd) \{}
\DoxyCodeLine{12 }
\DoxyCodeLine{13         \textcolor{keyword}{const} \textcolor{keywordtype}{size\_t} num\_segments = std::distance(workSharingIndexesBegin, workSharingIndexesEnd) -\/ 1;}
\DoxyCodeLine{14 }
\DoxyCodeLine{15         \textcolor{keywordtype}{size\_t} w\_min = *(prefixSumLoadEnd -\/ 1) / num\_segments;}
\DoxyCodeLine{16         \textcolor{keywordtype}{size\_t} w\_max = 2*w\_min + 1;}
\DoxyCodeLine{17 }
\DoxyCodeLine{18         std::vector<size\_t> separators(num\_segments -\/ 1, 0);}
\DoxyCodeLine{19 }
\DoxyCodeLine{20         \textcolor{comment}{/* probe function */}}
\DoxyCodeLine{21         \textcolor{keyword}{auto} probe\_load\_sharing = [\&](\textcolor{keywordtype}{size\_t} wprobe) \{}
\DoxyCodeLine{22             \textcolor{comment}{/* separators */}}
\DoxyCodeLine{23             \textcolor{keywordtype}{size\_t} last\_separator = 0;}
\DoxyCodeLine{24             \textcolor{keywordtype}{size\_t} last\_separator\_value = 0;}
\DoxyCodeLine{25 }
\DoxyCodeLine{26             \textcolor{comment}{/* find separators */}}
\DoxyCodeLine{27             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} separator = 0; separator < num\_segments -\/ 1; ++separator) \{}
\DoxyCodeLine{28                 \textcolor{keywordflow}{if} (*(prefixSumLoadEnd -\/ 1) -\/ last\_separator\_value > wprobe * (num\_segments -\/ separator))}
\DoxyCodeLine{29                     \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{30 }
\DoxyCodeLine{31                 \textcolor{comment}{/* dichotomie search of separator */}}
\DoxyCodeLine{32                 last\_separator = std::distance(prefixSumLoadBegin,}
\DoxyCodeLine{33                     std::upper\_bound(prefixSumLoadBegin + last\_separator, prefixSumLoadEnd, wprobe + last\_separator\_value)) -\/ 1;}
\DoxyCodeLine{34 }
\DoxyCodeLine{35                 \textcolor{comment}{/* prepare next iteration */}}
\DoxyCodeLine{36                 last\_separator\_value = prefixSumLoadBegin[last\_separator];}
\DoxyCodeLine{37                 separators[separator] = last\_separator;}
\DoxyCodeLine{38             \}}
\DoxyCodeLine{39 }
\DoxyCodeLine{40             \textcolor{comment}{/* check last segment */}}
\DoxyCodeLine{41             \textcolor{keywordflow}{if} (*(prefixSumLoadEnd -\/ 1) -\/ last\_separator\_value > wprobe)}
\DoxyCodeLine{42                 \textcolor{keywordflow}{return} \textcolor{keyword}{false};}
\DoxyCodeLine{43 }
\DoxyCodeLine{44             \textcolor{comment}{/* copy separators over */}}
\DoxyCodeLine{45             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{size\_t} i = 0; i < num\_segments -\/ 1; ++i)}
\DoxyCodeLine{46                 workSharingIndexesBegin[i + 1] = separators[i] -\/ 1;}
\DoxyCodeLine{47 }
\DoxyCodeLine{48             \textcolor{keywordflow}{return} \textcolor{keyword}{true};}
\DoxyCodeLine{49         \};}
\DoxyCodeLine{50 }
\DoxyCodeLine{51         \textcolor{comment}{/* check if their is a single segment */}}
\DoxyCodeLine{52         \textcolor{keywordflow}{if} (num\_segments > 1) \{}
\DoxyCodeLine{53 }
\DoxyCodeLine{54             \textcolor{comment}{/* dichotomic search */}}
\DoxyCodeLine{55             \textcolor{comment}{// "{}inverse"{} dichotomic search to find the upper bound}}
\DoxyCodeLine{56             \textcolor{keywordflow}{while}(!probe\_load\_sharing(w\_max)) \{ w\_max *= 2; \};}
\DoxyCodeLine{57 }
\DoxyCodeLine{58             \textcolor{comment}{// actual dichotomic search}}
\DoxyCodeLine{59             \textcolor{keywordflow}{while} (w\_max -\/ w\_min > 1) \{}
\DoxyCodeLine{60                 \textcolor{keywordtype}{size\_t} middle = (w\_min + w\_max) / 2;}
\DoxyCodeLine{61 }
\DoxyCodeLine{62                 \textcolor{keywordflow}{if} (probe\_load\_sharing(middle)) \{}
\DoxyCodeLine{63                     w\_max = middle;}
\DoxyCodeLine{64                 \} \textcolor{keywordflow}{else}}
\DoxyCodeLine{65                     w\_min = middle;}
\DoxyCodeLine{66             \}}
\DoxyCodeLine{67         \}}
\DoxyCodeLine{68         }
\DoxyCodeLine{69         *workSharingIndexesBegin = 0;}
\DoxyCodeLine{70         *(workSharingIndexesEnd -\/ 1) = std::distance(prefixSumLoadBegin, prefixSumLoadEnd) -\/ 1;}
\DoxyCodeLine{71     \}}
\DoxyCodeLine{72 \}}

\end{DoxyCode}
